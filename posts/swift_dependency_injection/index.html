<!doctype html><html lang=en><head><title>iOS æ¶æ„ä¹‹å¦ä¸€ç§ä¾èµ–æ³¨å…¥çš„æ€è·¯ ::
Dev Log</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="åœ¨ iOS ä¸šåŠ¡å¼€å‘è¿‡ç¨‹ç»å¸¸é¢å¯¹ç½‘ç»œè¯·æ±‚ï¼Œæ•°æ®æŒä¹…åŒ–è¿™æ ·å¸¦æœ‰å‰¯ä½œç”¨çš„æ“ä½œã€‚ä¸ºäº†èƒ½å¤Ÿåœ¨æµ‹è¯•ä¸­ mock è¿™äº›æ“ä½œï¼Œé€šå¸¸çš„åšæ³•å°±æ˜¯æŠ½è±¡ä¸€å±‚ protocol å‡ºæ¥ï¼Œç„¶åç¼–å†™ä¸åŒçš„å®ç°ã€‚
æ¯”å¦‚éœ€è¦å¤„ç†ä¸€ä¸ªç®€é™‹çš„æ³¨å†Œä¸šåŠ¡ï¼ˆç¤ºä¾‹çœç•¥äº†ä¸€ç‚¹ç»†èŠ‚ï¼‰ï¼Œéœ€è¦ç”¨æˆ·è¾“å…¥ä¿¡æ¯åå‘é€ç½‘ç»œè¯·æ±‚ï¼ŒæˆåŠŸåè¿”å›å¯¹åº”ç”¨æˆ·å¯¹è±¡ã€‚
é¦–å…ˆä¸ºç½‘ç»œè¯·æ±‚å®šä¹‰ä¸€ä¸ª protocolï¼š
protocol SignUpRepositoryProtocol: RepositoryProtocol {  func handleSignUp(name: String, email: String, pwd: String) -&amp;gt; AnyPublisher&amp;lt;User, Error&amp;gt; } å¯¹å…¶è¿›è¡Œå®ç°ï¼š
struct SignUpRepository: SignUpRepositoryProtocol {  func handleSignUp(name: String, email: String, pwd: String) -&amp;gt; AnyPublisher&amp;lt;User, Error&amp;gt; {  client(.signUp(name, email, pwd))  .map  .decode  .eraseToAnyPublisher()  } } å°†å…¶æ³¨å…¥åˆ° ViewModel æˆ–æ˜¯ Interactor ä¸­ï¼ˆå–å†³äºä½ é‡‡å–çš„æ¶æ„æ˜¯ä»€ä¹ˆ :p ï¼‰ï¼Œå¹¶ä¸”è°ƒç”¨å¯¹åº”æ–¹æ³•ï¼š
class SignUpViewModel {  enum State {  case loading  case success  case failed  }  let repository: SignUpRepositoryPortocol  var state: State = ."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://joeytat.github.io/posts/swift_dependency_injection/><link rel=stylesheet href=https://joeytat.github.io/assets/style.css><link rel=stylesheet href=https://joeytat.github.io/style.css><link rel=apple-touch-icon-precomposed sizes=144x144 href=https://joeytat.github.io/img/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=https://joeytat.github.io/img/favicon.png><link href=https://joeytat.github.io/assets/fonts/Inter-Italic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://joeytat.github.io/assets/fonts/Inter-Regular.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://joeytat.github.io/assets/fonts/Inter-Medium.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://joeytat.github.io/assets/fonts/Inter-MediumItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://joeytat.github.io/assets/fonts/Inter-Bold.woff2 rel=preload type=font/woff2 as=font crossorigin><link href=https://joeytat.github.io/assets/fonts/Inter-BoldItalic.woff2 rel=preload type=font/woff2 as=font crossorigin><meta name=twitter:card content="summary"><meta name=twitter:title content="iOS æ¶æ„ä¹‹å¦ä¸€ç§ä¾èµ–æ³¨å…¥çš„æ€è·¯"><meta name=twitter:description content="ä»‹ç»äº†ä¸€ç§ç›¸æ¯” protocol æ›´è½»é‡çº§æ›´çµæ´»çš„ä¾èµ–æ³¨å…¥å®ç°"><meta property="og:title" content="iOS æ¶æ„ä¹‹å¦ä¸€ç§ä¾èµ–æ³¨å…¥çš„æ€è·¯"><meta property="og:description" content="ä»‹ç»äº†ä¸€ç§ç›¸æ¯” protocol æ›´è½»é‡çº§æ›´çµæ´»çš„ä¾èµ–æ³¨å…¥å®ç°"><meta property="og:type" content="article"><meta property="og:url" content="https://joeytat.github.io/posts/swift_dependency_injection/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-03-15T00:00:00+00:00"><meta property="article:modified_time" content="2022-03-15T00:00:00+00:00"></head><body><div class=container><header class=header><span class=header__inner><a href=https://joeytat.github.io/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>Joeytat's Devlog</span>
<span class=logo__cursor></span></a>
<span class=header__right><span class=theme-toggle><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span></span></span></header><div class=content><div class=post><h1 class=post-title>iOS æ¶æ„ä¹‹å¦ä¸€ç§ä¾èµ–æ³¨å…¥çš„æ€è·¯</h1><div class=post-meta><span class=post-date>2022-03-15</span></div><span class=post-tags><a href=https://joeytat.github.io/tags/swift/>#Swift</a>&nbsp;</span><div class=post-content><p>åœ¨ iOS ä¸šåŠ¡å¼€å‘è¿‡ç¨‹ç»å¸¸é¢å¯¹ç½‘ç»œè¯·æ±‚ï¼Œæ•°æ®æŒä¹…åŒ–è¿™æ ·å¸¦æœ‰å‰¯ä½œç”¨çš„æ“ä½œã€‚ä¸ºäº†èƒ½å¤Ÿåœ¨æµ‹è¯•ä¸­ mock è¿™äº›æ“ä½œï¼Œé€šå¸¸çš„åšæ³•å°±æ˜¯æŠ½è±¡ä¸€å±‚ protocol å‡ºæ¥ï¼Œç„¶åç¼–å†™ä¸åŒçš„å®ç°ã€‚</p><p>æ¯”å¦‚éœ€è¦å¤„ç†ä¸€ä¸ªç®€é™‹çš„æ³¨å†Œä¸šåŠ¡ï¼ˆç¤ºä¾‹çœç•¥äº†ä¸€ç‚¹ç»†èŠ‚ï¼‰ï¼Œéœ€è¦ç”¨æˆ·è¾“å…¥ä¿¡æ¯åå‘é€ç½‘ç»œè¯·æ±‚ï¼ŒæˆåŠŸåè¿”å›å¯¹åº”ç”¨æˆ·å¯¹è±¡ã€‚</p><p>é¦–å…ˆä¸ºç½‘ç»œè¯·æ±‚å®šä¹‰ä¸€ä¸ª protocolï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>protocol</span> <span style=color:#a6e22e>SignUpRepositoryProtocol</span>: RepositoryProtocol {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>handleSignUp</span>(name: String, email: String, pwd: String) -&gt; AnyPublisher&lt;User, Error&gt; 
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å¯¹å…¶è¿›è¡Œå®ç°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>SignUpRepository</span>: SignUpRepositoryProtocol {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>handleSignUp</span>(name: String, email: String, pwd: String) -&gt; AnyPublisher&lt;User, Error&gt; {
</span></span><span style=display:flex><span>        client(.signUp(name, email, pwd))
</span></span><span style=display:flex><span>            .map
</span></span><span style=display:flex><span>            .decode
</span></span><span style=display:flex><span>            .eraseToAnyPublisher()
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å°†å…¶æ³¨å…¥åˆ° <code>ViewModel</code> æˆ–æ˜¯ <code>Interactor</code> ä¸­ï¼ˆå–å†³äºä½ é‡‡å–çš„æ¶æ„æ˜¯ä»€ä¹ˆ :p ï¼‰ï¼Œå¹¶ä¸”è°ƒç”¨å¯¹åº”æ–¹æ³•ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SignUpViewModel</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>State</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> loading
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> success
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> failed
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> repository: SignUpRepositoryPortocol
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> state: State = .loading
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>init</span>(repository: SignUpRepositoryPortocol) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>self</span>.repository = repository
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>onSubmit</span>(name: String, email: String, pwd: String) {
</span></span><span style=display:flex><span>        repository.hanldeSignUp(name: name, email: email, pwd: pwd)
</span></span><span style=display:flex><span>          .sink {[<span style=color:#66d9ef>weak</span> <span style=color:#66d9ef>self</span>] completion <span style=color:#66d9ef>in</span> 
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>switch</span> completion {
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>case</span> .failure: 
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>self</span>.?state = .failed
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>case</span> .finished: <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          } receiveValue: {[<span style=color:#66d9ef>weak</span> <span style=color:#66d9ef>self</span>] result <span style=color:#66d9ef>in</span> 
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>self</span>?.state = .success
</span></span><span style=display:flex><span>          }.store(<span style=color:#66d9ef>in</span>: &amp;bag)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ç”±æ­¤å¦‚æœéœ€è¦æµ‹è¯•å¯¹åº”çš„æ–¹æ³•ï¼Œåªéœ€è¦å†åˆ›å»ºä¸€ä»½ <code>MockSignUpRepository</code> çš„å®ç°å³å¯ï¼Œæ¯”å¦‚æƒ³è¦æµ‹è¯•æ³¨å†ŒæˆåŠŸæˆ–å¤±è´¥åœºæ™¯ä¸‹çš„å¤„ç†ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>MockSignUpRepository</span>: SignUpRepositoryPortocol {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> shouldSignUpSuccess: Bool
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>handleSignUp</span>(name: String, email: String, pwd: String) -&gt; AnyPublisher&lt;User, Error&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> shouldSignUpSuccess {
</span></span><span style=display:flex><span>            Just(User.mock)
</span></span><span style=display:flex><span>                .mapError{ <span style=color:#66d9ef>_</span> <span style=color:#66d9ef>in</span> SignUpError.someError }
</span></span><span style=display:flex><span>                .eraseToAnyPublisher()
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            Fail(error: SignUpError.someError)
</span></span><span style=display:flex><span>                .eraseToAnyPublisher() 
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åœ¨ç¼–å†™æµ‹è¯•çš„æ—¶å€™ï¼Œä¼ å…¥ <code>SignUpViewModel</code> çš„ä¾èµ–æ›¿æ¢æˆæˆ‘ä»¬æƒ³è¦æµ‹è¯•çš„ Mock å®ç°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>shouldSignUpSuccessWhenXXX</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Given</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> sut = SignUpViewModel(repository: MockSignUpSuccessRepository(shouldSignUpSuccess: <span style=color:#66d9ef>true</span>))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// When</span>
</span></span><span style=display:flex><span>    sut.onSubmit(...) <span style=color:#75715e>// åˆæ³•è¾“å…¥</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Then</span>
</span></span><span style=display:flex><span>    XCTAssertEqual(sut.state, .success)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>shouldSignUpFailWhenXXX</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Given</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> sut = SignUpViewModel(repository: MockSignUpSuccessRepository(shouldSignUpSuccess: <span style=color:#66d9ef>false</span>))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// When</span>
</span></span><span style=display:flex><span>    sut.onSubmit(...) <span style=color:#75715e>// éæ³•è¾“å…¥</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Then</span>
</span></span><span style=display:flex><span>    XCTAssertEqual(sut.state, .failed)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™æ—¶å€™ä¼¼ä¹ä¸€åˆ‡éƒ½å¾ˆç¾å¥½ï¼Œä½†ç°åœ¨å†è¡¥å……ä¸€äº›ä¸šåŠ¡éœ€æ±‚ï¼Œå¦‚æœéœ€è¦è¿”å›ä¸åŒçš„é”™è¯¯ç±»å‹æ€ä¹ˆåŠï¼Ÿæ¯”å¦‚ç”¨æˆ·åé”™è¯¯ï¼Œé‚£å°±éœ€è¦é¢å¤–çš„å¸ƒå°”å€¼æ¥è¡¨ç¤ºï¼›å†æ¯”å¦‚é‚®ç®±é”™è¯¯ï¼Œé‚£åˆéœ€è¦å¢åŠ æ–°çš„å¸ƒå°”å€¼ã€‚è€Œè¿™è¿˜ä»…ä»…åªæ˜¯ä¸€ä¸ªæ–¹æ³•çš„å‡ ä¸ªåˆ†æ”¯é€»è¾‘å¤„ç†ã€‚å½“å‡ºç°è¾ƒå¤šçš„é€»è¾‘åˆ†æ”¯ä¹‹åï¼Œå¦‚æœæˆ‘ä»¬å®é™…çš„ä¸šåŠ¡å†å‘ç”Ÿå˜åŠ¨éœ€è¦é‡æ„ï¼Œé‚£è¿˜å¾—å»å¯¹ Mock ç±»ä¹Ÿè¿›è¡Œé‡æ„ï¼ŒåŒæ—¶è¿˜éœ€è¦ç¡®ä¿è¿™äº›æ§åˆ¶é€»è¾‘åˆ†æ”¯çš„å¸ƒå°”å€¼ä¹Ÿå¾—åˆ°äº†æ­£ç¡®çš„æ›´æ–°ã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>let</span> sut = SignUpViewModel(
</span></span><span style=display:flex><span>    repository: MockSignUpSuccessRepository(
</span></span><span style=display:flex><span>        shouldSignUpSuccess: <span style=color:#66d9ef>false</span>, 
</span></span><span style=display:flex><span>        shouldShowUsernameError: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        shouldShowEmailError: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        shouldUsernamePassValidation: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        shouldEmailPassValidation: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#75715e>// ...ğŸ˜±</span>
</span></span><span style=display:flex><span>   )
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>è¿™æ—¶å€™å°±å¯ä»¥ä»‹ç»å¦ä¸€ç§ä¾èµ–æ³¨å…¥æ–¹å¼äº†ã€‚é¦–å…ˆå®šä¹‰ä¸€ä¸ª <code>Repository</code> å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å°±åƒä¹‹å‰çš„ <code>Repository</code> ä¸€æ ·ï¼ŒåŒºåˆ«æ˜¯ç½‘ç»œè¯·æ±‚é€šè¿‡ä¸€ä¸ªå±æ€§æ¥æŒæœ‰ï¼ŒåŒæ—¶ä¼šæä¾›ä¸€ä¸ªæ ‡è®°ä¸º private çš„é»˜è®¤å®ç°ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Repository</span> {  
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> handleSignUp = handleSignUp(name:, email:, pwd:)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>handleSignUp</span>(name: String, email: String, pwd: String) -&gt; AnyPublisher&lt;User, Error&gt; {
</span></span><span style=display:flex><span>    client(.signUp(name, email, pwd))
</span></span><span style=display:flex><span>        .map
</span></span><span style=display:flex><span>        .decode
</span></span><span style=display:flex><span>        .eraseToAnyPublisher()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ç„¶åå°†è¿™ä¸ª <code>Repository</code> å®ä¾‹æ”¾åˆ°ä¸€ä¸ª <code>Environment</code> å¯¹è±¡ä¸­ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>Environment</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> repo = Repository()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>åŒæ—¶æ›¿æ¢ ViewModel ä¸­ä¹‹å‰å¯¹ <code>Repository</code> çš„å¼•ç”¨ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SignUpViewModel</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>State</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> loading
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> success
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>case</span> failed
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#75715e>// let repository: SignUpRepositoryPortocol</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> current: Environment <span style=color:#75715e>// ğŸ‘ˆ</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> state: State = .loading
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>init</span>(current: Environment) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>self</span>.current = current <span style=color:#75715e>// ğŸ‘ˆ</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>func</span> <span style=color:#a6e22e>onSubmit</span>(name: String, email: String, pwd: String) {
</span></span><span style=display:flex><span>        current.repo.hanldeSignUp(name, email, pwd) <span style=color:#75715e>// ğŸ‘ˆ</span>
</span></span><span style=display:flex><span>          .sink { completion <span style=color:#66d9ef>in</span> 
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>switch</span> completion {
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>case</span> .failure: 
</span></span><span style=display:flex><span>                <span style=color:#66d9ef>self</span>.state = .failed
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>case</span> .finished: <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>          } receiveValue: {[<span style=color:#66d9ef>weak</span> <span style=color:#66d9ef>self</span>] result <span style=color:#66d9ef>in</span> 
</span></span><span style=display:flex><span>              <span style=color:#66d9ef>self</span>?.state = .success
</span></span><span style=display:flex><span>          }.store(<span style=color:#66d9ef>in</span>: &amp;bag)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä»£ç å‡ ä¹å’Œä¹‹å‰ç›¸åŒï¼Œä½†ä¿æŒäº†æ›´é«˜çš„å¯æ›¿æ¢æ€§ï¼Œæ€ä¹ˆä½“ç°çš„å‘¢ï¼Ÿéœ€è¦ mock ç½‘ç»œè¯·æ±‚ æ—¶ï¼Œå¯ä»¥ç»™ Repository åˆ›å»ºä¸€ä¸ª extensionï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>extension</span> <span style=color:#a6e22e>Repository</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>let</span> mock = Repository(
</span></span><span style=display:flex><span>        handleSignUp: Just(User.mock)
</span></span><span style=display:flex><span>                          .mapError{ <span style=color:#66d9ef>_</span> <span style=color:#66d9ef>in</span> SignUpError.someError }
</span></span><span style=display:flex><span>                          .eraseToAnyPublisher()
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ç„¶ååœ¨æµ‹è¯•ä»£ç æ„å»º ViewModel çš„æ—¶å€™å°±å¯ä»¥å°† Mock ä¼ é€’è¿›å»ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>shouldSignUpSuccessWhenXXX</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Given</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> sut = SignUpViewModel(current: Environment(repo: Repository.mock))
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// When</span>
</span></span><span style=display:flex><span>    sut.onSubmit(...) <span style=color:#75715e>// åˆæ³•è¾“å…¥</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Then</span>
</span></span><span style=display:flex><span>    XCTAssertEqual(sut.state, .success)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>å¯¹äºæ–¹æ³•å¤šåˆ†æ”¯çš„é€»è¾‘ï¼Œåˆ™å¯ä»¥ç‹¬ç«‹å®ç°ä¸€ä»½ï¼Œè€Œä¸æ˜¯é‡æ–°åˆ›å»ºæ•´ä¸ª <code>MockRepository</code> ç±»æˆ–è€…æ˜¯ç”¨ä¸€äº›å˜é‡æ¥æ§åˆ¶åˆ†æ”¯é€»è¾‘ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-swift data-lang=swift><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>shouldSignUpFailWhenXXX</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Given</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> sut = SignUpViewModel(
</span></span><span style=display:flex><span>        current: Environment(
</span></span><span style=display:flex><span>            repo: Repository(handleSignUp: 
</span></span><span style=display:flex><span>                Fail(error: SignUpError.someError).eraseToAnyPublisher()
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>        )
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// When</span>
</span></span><span style=display:flex><span>    sut.onSubmit(...) <span style=color:#75715e>// éæ³•è¾“å…¥</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Then</span>
</span></span><span style=display:flex><span>    XCTAssertEqual(sut.state, .failed)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>è¿™ç§æ–¹å¼æ¥æ³¨å…¥ä¾èµ–çš„ä¼˜åŠ¿åœ¨äºï¼š</p><ul><li>ä¸éœ€è¦åƒ protocol é‚£æ ·å†™å¤ªå¤šæ¨¡ç‰ˆä»£ç </li><li>mock çš„é€»è¾‘åˆ†æ”¯å¾ˆå®¹æ˜“å¯ä»¥å®ç°ç›¸äº’ç‹¬ç«‹çš„ç‰ˆæœ¬</li><li>ä¾èµ–çš„å‰¯ä½œç”¨ä¼šæ›´å®¹æ˜“ mockï¼Œç‰¹åˆ«æ˜¯ç³»ç»Ÿç±»</li></ul></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://joeytat.github.io/posts/apple_swiftui_workshop/><span class=button__icon>â†</span>
<span class=button__text>å‚åŠ  Apple å¼€å‘è€…çº¿ä¸Šæ´»åŠ¨æ˜¯ä»€ä¹ˆæ ·çš„ä½“éªŒï¼Ÿ</span></a></span>
<span class="button next"><a href=https://joeytat.github.io/posts/combining_reducers/><span class=button__text>Swift çŠ¶æ€ç®¡ç† â€”â€” å¦‚ä½•æ‹†åˆ†åºå¤§çš„ reducer</span>
<span class=button__icon>â†’</span></a></span></div></div></div></div><footer class=footer><div class=footer__inner><a href=https://joeytat.github.io/ class=logo style=text-decoration:none><span class=logo__mark><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44"><path fill="none" d="M15 8l14.729 14.382L15 35.367"/></svg></span><span class=logo__text>Joeytat's Devlog</span>
<span class=logo__cursor></span></a><div class=copyright><span>Â© 2022 Powered by
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a></span>
<span>Theme created by
<a href=https://twitter.com/panr target=_blank rel=noopener>panr</a></span></div></div></footer><script src=https://joeytat.github.io/assets/main.js></script>
<script src=https://joeytat.github.io/assets/prism.js></script></div><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-131363452-1","auto"),ga("send","pageview"))</script></body></html>