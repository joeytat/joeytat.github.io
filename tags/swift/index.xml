<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Swift on Dev Log</title><link>https://joeytat.github.io/tags/swift/</link><description>Recent content in Swift on Dev Log</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Tue, 15 Mar 2022 00:00:00 +0000</lastBuildDate><atom:link href="https://joeytat.github.io/tags/swift/index.xml" rel="self" type="application/rss+xml"/><item><title>iOS æ¶æ„ä¹‹å¦ä¸€ç§ä¾èµ–æ³¨å…¥çš„æ€è·¯</title><link>https://joeytat.github.io/posts/swift_dependency_injection/</link><pubDate>Tue, 15 Mar 2022 00:00:00 +0000</pubDate><guid>https://joeytat.github.io/posts/swift_dependency_injection/</guid><description>
&lt;p>åœ¨ iOS ä¸šåŠ¡å¼€å‘è¿‡ç¨‹ç»å¸¸é¢å¯¹ç½‘ç»œè¯·æ±‚ï¼Œæ•°æ®æŒä¹…åŒ–è¿™æ ·å¸¦æœ‰å‰¯ä½œç”¨çš„æ“ä½œã€‚ä¸ºäº†èƒ½å¤Ÿåœ¨æµ‹è¯•ä¸­ mock è¿™äº›æ“ä½œï¼Œé€šå¸¸çš„åšæ³•å°±æ˜¯æŠ½è±¡ä¸€å±‚ protocol å‡ºæ¥ï¼Œç„¶åç¼–å†™ä¸åŒçš„å®ç°ã€‚&lt;/p>
&lt;p>æ¯”å¦‚éœ€è¦å¤„ç†ä¸€ä¸ªç®€é™‹çš„æ³¨å†Œä¸šåŠ¡ï¼ˆç¤ºä¾‹çœç•¥äº†ä¸€ç‚¹ç»†èŠ‚ï¼‰ï¼Œéœ€è¦ç”¨æˆ·è¾“å…¥ä¿¡æ¯åå‘é€ç½‘ç»œè¯·æ±‚ï¼ŒæˆåŠŸåè¿”å›å¯¹åº”ç”¨æˆ·å¯¹è±¡ã€‚&lt;/p>
&lt;p>é¦–å…ˆä¸ºç½‘ç»œè¯·æ±‚å®šä¹‰ä¸€ä¸ª protocolï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">protocol&lt;/span> &lt;span style="color:#a6e22e">SignUpRepositoryProtocol&lt;/span>: RepositoryProtocol {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">handleSignUp&lt;/span>(name: String, email: String, pwd: String) -&amp;gt; AnyPublisher&amp;lt;User, Error&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹å…¶è¿›è¡Œå®ç°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">SignUpRepository&lt;/span>: SignUpRepositoryProtocol {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">handleSignUp&lt;/span>(name: String, email: String, pwd: String) -&amp;gt; AnyPublisher&amp;lt;User, Error&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> client(.signUp(name, email, pwd))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .map
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .decode
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .eraseToAnyPublisher()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å°†å…¶æ³¨å…¥åˆ° &lt;code>ViewModel&lt;/code> æˆ–æ˜¯ &lt;code>Interactor&lt;/code> ä¸­ï¼ˆå–å†³äºä½ é‡‡å–çš„æ¶æ„æ˜¯ä»€ä¹ˆ :p ï¼‰ï¼Œå¹¶ä¸”è°ƒç”¨å¯¹åº”æ–¹æ³•ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">SignUpViewModel&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">enum&lt;/span> &lt;span style="color:#a6e22e">State&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> loading
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> success
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> failed
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> repository: SignUpRepositoryPortocol
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">var&lt;/span> state: State = .loading
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">init&lt;/span>(repository: SignUpRepositoryPortocol) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">self&lt;/span>.repository = repository
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">onSubmit&lt;/span>(name: String, email: String, pwd: String) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> repository.hanldeSignUp(name: name, email: email, pwd: pwd)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .sink {[&lt;span style="color:#66d9ef">weak&lt;/span> &lt;span style="color:#66d9ef">self&lt;/span>] completion &lt;span style="color:#66d9ef">in&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">switch&lt;/span> completion {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> .failure:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">self&lt;/span>.?state = .failed
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> .finished: &lt;span style="color:#66d9ef">break&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } receiveValue: {[&lt;span style="color:#66d9ef">weak&lt;/span> &lt;span style="color:#66d9ef">self&lt;/span>] result &lt;span style="color:#66d9ef">in&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">self&lt;/span>?.state = .success
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }.store(&lt;span style="color:#66d9ef">in&lt;/span>: &amp;amp;bag)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç”±æ­¤å¦‚æœéœ€è¦æµ‹è¯•å¯¹åº”çš„æ–¹æ³•ï¼Œåªéœ€è¦å†åˆ›å»ºä¸€ä»½ &lt;code>MockSignUpRepository&lt;/code> çš„å®ç°å³å¯ï¼Œæ¯”å¦‚æƒ³è¦æµ‹è¯•æ³¨å†ŒæˆåŠŸæˆ–å¤±è´¥åœºæ™¯ä¸‹çš„å¤„ç†ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">MockSignUpRepository&lt;/span>: SignUpRepositoryPortocol {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> shouldSignUpSuccess: Bool
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">handleSignUp&lt;/span>(name: String, email: String, pwd: String) -&amp;gt; AnyPublisher&amp;lt;User, Error&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">if&lt;/span> shouldSignUpSuccess {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Just(User.mock)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .mapError{ &lt;span style="color:#66d9ef">_&lt;/span> &lt;span style="color:#66d9ef">in&lt;/span> SignUpError.someError }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .eraseToAnyPublisher()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#66d9ef">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Fail(error: SignUpError.someError)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .eraseToAnyPublisher()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åœ¨ç¼–å†™æµ‹è¯•çš„æ—¶å€™ï¼Œä¼ å…¥ &lt;code>SignUpViewModel&lt;/code> çš„ä¾èµ–æ›¿æ¢æˆæˆ‘ä»¬æƒ³è¦æµ‹è¯•çš„ Mock å®ç°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">shouldSignUpSuccessWhenXXX&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Given&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> sut = SignUpViewModel(repository: MockSignUpSuccessRepository(shouldSignUpSuccess: &lt;span style="color:#66d9ef">true&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// When&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sut.onSubmit(...) &lt;span style="color:#75715e">// åˆæ³•è¾“å…¥&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> XCTAssertEqual(sut.state, .success)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">shouldSignUpFailWhenXXX&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Given&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> sut = SignUpViewModel(repository: MockSignUpSuccessRepository(shouldSignUpSuccess: &lt;span style="color:#66d9ef">false&lt;/span>))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// When&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sut.onSubmit(...) &lt;span style="color:#75715e">// éæ³•è¾“å…¥&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> XCTAssertEqual(sut.state, .failed)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™æ—¶å€™ä¼¼ä¹ä¸€åˆ‡éƒ½å¾ˆç¾å¥½ï¼Œä½†ç°åœ¨å†è¡¥å……ä¸€äº›ä¸šåŠ¡éœ€æ±‚ï¼Œå¦‚æœéœ€è¦è¿”å›ä¸åŒçš„é”™è¯¯ç±»å‹æ€ä¹ˆåŠï¼Ÿæ¯”å¦‚ç”¨æˆ·åé”™è¯¯ï¼Œé‚£å°±éœ€è¦é¢å¤–çš„å¸ƒå°”å€¼æ¥è¡¨ç¤ºï¼›å†æ¯”å¦‚é‚®ç®±é”™è¯¯ï¼Œé‚£åˆéœ€è¦å¢åŠ æ–°çš„å¸ƒå°”å€¼ã€‚è€Œè¿™è¿˜ä»…ä»…åªæ˜¯ä¸€ä¸ªæ–¹æ³•çš„å‡ ä¸ªåˆ†æ”¯é€»è¾‘å¤„ç†ã€‚å½“å‡ºç°è¾ƒå¤šçš„é€»è¾‘åˆ†æ”¯ä¹‹åï¼Œå¦‚æœæˆ‘ä»¬å®é™…çš„ä¸šåŠ¡å†å‘ç”Ÿå˜åŠ¨éœ€è¦é‡æ„ï¼Œé‚£è¿˜å¾—å»å¯¹ Mock ç±»ä¹Ÿè¿›è¡Œé‡æ„ï¼ŒåŒæ—¶è¿˜éœ€è¦ç¡®ä¿è¿™äº›æ§åˆ¶é€»è¾‘åˆ†æ”¯çš„å¸ƒå°”å€¼ä¹Ÿå¾—åˆ°äº†æ­£ç¡®çš„æ›´æ–°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">let&lt;/span> sut = SignUpViewModel(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> repository: MockSignUpSuccessRepository(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> shouldSignUpSuccess: &lt;span style="color:#66d9ef">false&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> shouldShowUsernameError: &lt;span style="color:#66d9ef">true&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> shouldShowEmailError: &lt;span style="color:#66d9ef">true&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> shouldUsernamePassValidation: &lt;span style="color:#66d9ef">true&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> shouldEmailPassValidation: &lt;span style="color:#66d9ef">true&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ...ğŸ˜±&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™æ—¶å€™å°±å¯ä»¥ä»‹ç»å¦ä¸€ç§ä¾èµ–æ³¨å…¥æ–¹å¼äº†ã€‚é¦–å…ˆå®šä¹‰ä¸€ä¸ª &lt;code>Repository&lt;/code> å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡å°±åƒä¹‹å‰çš„ &lt;code>Repository&lt;/code> ä¸€æ ·ï¼ŒåŒºåˆ«æ˜¯ç½‘ç»œè¯·æ±‚é€šè¿‡ä¸€ä¸ªå±æ€§æ¥æŒæœ‰ï¼ŒåŒæ—¶ä¼šæä¾›ä¸€ä¸ªæ ‡è®°ä¸º private çš„é»˜è®¤å®ç°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Repository&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">var&lt;/span> handleSignUp = handleSignUp(name:, email:, pwd:)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">private&lt;/span> &lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">handleSignUp&lt;/span>(name: String, email: String, pwd: String) -&amp;gt; AnyPublisher&amp;lt;User, Error&amp;gt; {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> client(.signUp(name, email, pwd))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .map
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .decode
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .eraseToAnyPublisher()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶åå°†è¿™ä¸ª &lt;code>Repository&lt;/code> å®ä¾‹æ”¾åˆ°ä¸€ä¸ª &lt;code>Environment&lt;/code> å¯¹è±¡ä¸­ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">struct&lt;/span> &lt;span style="color:#a6e22e">Environment&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">var&lt;/span> repo = Repository()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åŒæ—¶æ›¿æ¢ ViewModel ä¸­ä¹‹å‰å¯¹ &lt;code>Repository&lt;/code> çš„å¼•ç”¨ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">class&lt;/span> &lt;span style="color:#a6e22e">SignUpViewModel&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">enum&lt;/span> &lt;span style="color:#a6e22e">State&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> loading
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> success
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> failed
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// let repository: SignUpRepositoryPortocol&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> current: Environment &lt;span style="color:#75715e">// ğŸ‘ˆ&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">var&lt;/span> state: State = .loading
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">init&lt;/span>(current: Environment) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">self&lt;/span>.current = current &lt;span style="color:#75715e">// ğŸ‘ˆ&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">onSubmit&lt;/span>(name: String, email: String, pwd: String) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> current.repo.hanldeSignUp(name, email, pwd) &lt;span style="color:#75715e">// ğŸ‘ˆ&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .sink { completion &lt;span style="color:#66d9ef">in&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">switch&lt;/span> completion {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> .failure:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">self&lt;/span>.state = .failed
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> .finished: &lt;span style="color:#66d9ef">break&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } receiveValue: {[&lt;span style="color:#66d9ef">weak&lt;/span> &lt;span style="color:#66d9ef">self&lt;/span>] result &lt;span style="color:#66d9ef">in&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">self&lt;/span>?.state = .success
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }.store(&lt;span style="color:#66d9ef">in&lt;/span>: &amp;amp;bag)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä»£ç å‡ ä¹å’Œä¹‹å‰ç›¸åŒï¼Œä½†ä¿æŒäº†æ›´é«˜çš„å¯æ›¿æ¢æ€§ï¼Œæ€ä¹ˆä½“ç°çš„å‘¢ï¼Ÿéœ€è¦ mock ç½‘ç»œè¯·æ±‚ æ—¶ï¼Œå¯ä»¥ç»™ Repository åˆ›å»ºä¸€ä¸ª extensionï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">extension&lt;/span> &lt;span style="color:#a6e22e">Repository&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">static&lt;/span> &lt;span style="color:#66d9ef">let&lt;/span> mock = Repository(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> handleSignUp: Just(User.mock)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .mapError{ &lt;span style="color:#66d9ef">_&lt;/span> &lt;span style="color:#66d9ef">in&lt;/span> SignUpError.someError }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> .eraseToAnyPublisher()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç„¶ååœ¨æµ‹è¯•ä»£ç æ„å»º ViewModel çš„æ—¶å€™å°±å¯ä»¥å°† Mock ä¼ é€’è¿›å»ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">shouldSignUpSuccessWhenXXX&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Given&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> sut = SignUpViewModel(current: Environment(repo: Repository.mock))
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// When&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sut.onSubmit(...) &lt;span style="color:#75715e">// åˆæ³•è¾“å…¥&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> XCTAssertEqual(sut.state, .success)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹äºæ–¹æ³•å¤šåˆ†æ”¯çš„é€»è¾‘ï¼Œåˆ™å¯ä»¥ç‹¬ç«‹å®ç°ä¸€ä»½ï¼Œè€Œä¸æ˜¯é‡æ–°åˆ›å»ºæ•´ä¸ª &lt;code>MockRepository&lt;/code> ç±»æˆ–è€…æ˜¯ç”¨ä¸€äº›å˜é‡æ¥æ§åˆ¶åˆ†æ”¯é€»è¾‘ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">shouldSignUpSuccessWhenXXX&lt;/span>() {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Given&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> sut = SignUpViewModel(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> current: Environment(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> repo: Repository(handleSignUp:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Fail(error: SignUpError.someError).eraseToAnyPublisher()
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// When&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sut.onSubmit(...) &lt;span style="color:#75715e">// éæ³•è¾“å…¥&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// Then&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> XCTAssertEqual(sut.state, .success)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ç§æ–¹å¼æ¥æ³¨å…¥ä¾èµ–çš„ä¼˜åŠ¿åœ¨äºï¼š&lt;/p>
&lt;ul>
&lt;li>ä¸éœ€è¦åƒ protocol é‚£æ ·å†™å¤ªå¤šæ¨¡ç‰ˆä»£ç &lt;/li>
&lt;li>mock çš„é€»è¾‘åˆ†æ”¯å¾ˆå®¹æ˜“å¯ä»¥å®ç°ç›¸äº’ç‹¬ç«‹çš„ç‰ˆæœ¬&lt;/li>
&lt;li>ä¾èµ–çš„å‰¯ä½œç”¨ä¼šæ›´å®¹æ˜“ mockï¼Œç‰¹åˆ«æ˜¯ç³»ç»Ÿç±»&lt;/li>
&lt;/ul></description></item><item><title>Swift çŠ¶æ€ç®¡ç† â€”â€” å¦‚ä½•æ‹†åˆ†åºå¤§çš„ reducer</title><link>https://joeytat.github.io/posts/combining_reducers/</link><pubDate>Sun, 16 Jan 2022 00:00:00 +0000</pubDate><guid>https://joeytat.github.io/posts/combining_reducers/</guid><description>
&lt;p>å› ä¸ºé¡¹ç›®éœ€è¦ä½¿ç”¨ SwiftUIï¼Œæƒ³èµ·æ¥ä¹‹å‰ä¹°è¿‡å–µç¥çš„ &lt;a href="https://objccn.io/products/swift-ui">ã€ŠSwiftUI ä¸ Combine ç¼–ç¨‹ã€‹&lt;/a> ã€‚ä¹¦ä¸­ä»‹ç»äº† &lt;a href="https://redux.js.org">Redux&lt;/a> è¿™ä¸€åœ¨ Web å‰ç«¯é¢†åŸŸå¹¿æ³›è¢«éªŒè¯è¿‡çš„æ•°æ®ç®¡ç†æ¨¡å¼æ˜¯å¦‚ä½•é€šè¿‡ Swift æ¥å®ç°çš„ï¼Œéå¸¸æ¨è SwiftUI åˆè§è€…é˜…è¯»ã€‚&lt;/p>
&lt;p>åœ¨å­¦ä¹ è¿‡ç¨‹ä¸­è¿˜äº§ç”Ÿäº†ä¸€ä¸ªç–‘é—®ï¼Œå¦‚æœ reducer è¶Šæ¥è¶Šå¤§ï¼Œæœ‰ä»€ä¹ˆæ›´ â€œswiftâ€ çš„åŠæ³•èƒ½è§£å†³è¿™ä¸€é—®é¢˜å‘¢ï¼Ÿï¼ˆåœ¨ Redux.js ä¸­çš„åŸç”Ÿè§£å†³æ–¹æ¡ˆæ˜¯ &lt;a href="https://redux.js.org/usage/structuring-reducers/beyond-combinereducers">&lt;code>combineReducers&lt;/code>&lt;/a>ï¼‰&lt;/p>
&lt;h2 id="æ‹†åˆ†-reducer">
æ‹†åˆ† Reducer
&lt;a href="#%e6%8b%86%e5%88%86-reducer" class="h-anchor" aria-hidden="true">#&lt;/a>
&lt;/h2>
&lt;p>é¦–å…ˆçœ‹çœ‹é—®é¢˜åœ¨ä»£ç ä¸­çš„è¡¨ç°æ˜¯ä»€ä¹ˆæ ·çš„ï¼Œå‡è®¾æˆ‘ä»¬æœ‰è¿™æ ·ä¸€ä¸ª reducerï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">appReducer&lt;/span>(appState: &lt;span style="color:#66d9ef">inout&lt;/span> AppState, action: AppAction) -&amp;gt; Void {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">switch&lt;/span> action {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> .emailValid(&lt;span style="color:#66d9ef">let&lt;/span> isValid):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> appState.settings.isEmailValid = isValid
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> .register(&lt;span style="color:#66d9ef">let&lt;/span> email, &lt;span style="color:#66d9ef">let&lt;/span> password):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> appState.settings.loginUser = User(email, password)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> .login(&lt;span style="color:#66d9ef">let&lt;/span> email, &lt;span style="color:#66d9ef">let&lt;/span> password):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> appState.settings.loginUser = User(email, password)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> .logout:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> appState.settings.loginUser = &lt;span style="color:#66d9ef">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> .loadPokemon(&lt;span style="color:#66d9ef">let&lt;/span> result):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> appState.pokemonList.pokemons = result
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> .favoratePokemon(&lt;span style="color:#66d9ef">let&lt;/span> pokemon):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> appState.favoritePokemons.append(pokemon)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> .removeFavoritePokemon(&lt;span style="color:#66d9ef">let&lt;/span> pokemon):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> index = appState.favoritePokemons.indexOf(pokemon)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> appState.favoritePokemons.remove(at: index)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åº”ç”¨çš„ action ä¸»è¦åŒ…å«ä¸‰ä¸ªæ¨¡å—ï¼š&lt;/p>
&lt;ul>
&lt;li>è´¦å·ç™»å½•æ³¨å†Œæ³¨é”€&lt;/li>
&lt;li>å¯¹ç¥å¥‡å®è´æ•°æ®è¿›è¡ŒåŠ è½½&lt;/li>
&lt;li>å¤„ç†å¯¹ç¥å¥‡å®è´æ•°æ®çš„æ”¶è—å’Œå–æ¶ˆæ”¶è—&lt;/li>
&lt;/ul>
&lt;p>ä»è¿™æ®µä»£ç æˆ‘ä»¬å¾ˆå¿«å°±èƒ½å‘ç°ï¼Œå³ä½¿åªæ˜¯éå¸¸ç®€å•çš„ç¤ºä¾‹ä¹Ÿå·²ç»åŒ…å«äº†ä¸çŸ­çš„ä»£ç äº†ã€‚è¿™é‡Œè¿˜çœç•¥æ‰äº†å¤„ç†çŠ¶æ€æ—¶å¯èƒ½è¿˜éœ€è¦çš„å¼‚æ­¥ action çš„å¤„ç†ï¼ˆæ•°æ®åŠ è½½ç­‰ï¼‰ã€‚è¿™è¿˜ä»…ä»…åªæœ‰ä¸¤ä¸ªéå¸¸ç®€å•çš„ç•Œé¢çŠ¶æ€ï¼Œå½“é¢å¯¹çœŸå®çš„ app æ‰€éœ€è¦å¤„ç†çš„æ•°åä¸ªé¡µé¢çŠ¶æ€ä¼šæ›´ææ€–ã€‚&lt;/p>
&lt;p>å°† reducer æ‹†åˆ†æˆå¦‚ä¸‹ä¸‰ä¸ªç‹¬ç«‹ reducerï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">accountReducer&lt;/span>(appState: &lt;span style="color:#66d9ef">inout&lt;/span> AppState, action: AppAction) -&amp;gt; Void {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">switch&lt;/span> action {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> .emailValid(&lt;span style="color:#66d9ef">let&lt;/span> isValid):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> appState.settings.isEmailValid = isValid
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> .register(&lt;span style="color:#66d9ef">let&lt;/span> email, &lt;span style="color:#66d9ef">let&lt;/span> password):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> appState.settings.loginUser = User(email, password)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> .login(&lt;span style="color:#66d9ef">let&lt;/span> email, &lt;span style="color:#66d9ef">let&lt;/span> password):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> appState.settings.loginUser = User(email, password)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> .logout:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> appState.settings.loginUser = &lt;span style="color:#66d9ef">nil&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">default&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">pokemonListReducer&lt;/span>(appState: &lt;span style="color:#66d9ef">inout&lt;/span> AppState, action: AppAction) -&amp;gt; Void {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">switch&lt;/span> action {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> .loadPokemon(&lt;span style="color:#66d9ef">let&lt;/span> result):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> appState.pokemonList.pokemons = result
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">default&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">favoritePokemonReducer&lt;/span>(appState: &lt;span style="color:#66d9ef">inout&lt;/span> AppState, action: AppAction) -&amp;gt; Void {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">switch&lt;/span> action {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> .favoratePokemon(&lt;span style="color:#66d9ef">let&lt;/span> pokemon):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> appState.favoritePokemons.append(pokemon)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> .removeFavoritePokemon(&lt;span style="color:#66d9ef">let&lt;/span> pokemon):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">let&lt;/span> index = appState.favoritePokemons.indexOf(pokemon)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> appState.favoritePokemons.remove(at: index)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">default&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å› ä¸ºå¯¹ reducer çš„æ•°é‡å¹¶ä¸ç¡®å®šï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨å¯å˜å‚æ•°æ¥æ„å»º &lt;code>combine&lt;/code> æ–¹æ³•ï¼Œå¯¹ä¼ å…¥çš„ reducer è¿›è¡Œéå†è°ƒç”¨å¤„ç† appStateã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">combine&lt;/span>&amp;lt;Value, Action&amp;gt;(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">_&lt;/span> reducers: (&lt;span style="color:#66d9ef">inout&lt;/span> Value, Action) -&amp;gt; Void...
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>) -&amp;gt; (&lt;span style="color:#66d9ef">inout&lt;/span> Value, Action) -&amp;gt; Void {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> { value, action &lt;span style="color:#66d9ef">in&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">for&lt;/span> reducer &lt;span style="color:#66d9ef">in&lt;/span> reducers {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> reducer(&amp;amp;value, action)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">let&lt;/span> appReducer = combine(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> accountReducer,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pokemonListReducer,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> favoritePokemonReducer
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å®Œæˆï¼Œæˆ‘ä»¬çš„å·¨å¤§ reducer è¢«æ‹†åˆ†æˆäº†ç‹¬ç«‹çš„ reducerï¼Œå†é€šè¿‡è‡ªå·±å®ç°çš„ combine æ–¹æ³•å®Œæˆäº†ç»„è£…ã€‚&lt;/p>
&lt;h2 id="éš”ç¦»-reducer-æ•°æ®">
éš”ç¦» reducer æ•°æ®
&lt;a href="#%e9%9a%94%e7%a6%bb-reducer-%e6%95%b0%e6%8d%ae" class="h-anchor" aria-hidden="true">#&lt;/a>
&lt;/h2>
&lt;p>ä½†ä»”ç»†è§‚çœ‹ä»£ç è¿˜ä¼šå‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œæ¯ä¸ª reducer éƒ½åªéœ€è¦å¤„ç† &lt;code>appState&lt;/code> ä¸Šçš„éƒ¨åˆ†æ•°æ®ï¼Œæ¯”å¦‚ &lt;code>pokemonListReducer&lt;/code> æ˜æ˜åªæ“ä½œäº† &lt;code>appState.pokemonList&lt;/code>ï¼Œæˆ‘ä»¬å´æŠŠæ•´ä¸ª state éƒ½ä¸¢ç»™äº†å®ƒï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">pokemonListReducer&lt;/span>(appState: &lt;span style="color:#66d9ef">inout&lt;/span> AppState, action: AppAction) -&amp;gt; Void {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">switch&lt;/span> action {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> .loadPokemon(&lt;span style="color:#66d9ef">let&lt;/span> result):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> appState.pokemonList.pokemons = result
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">default&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™ä¼šå¢åŠ ä»£ç ç»´æŠ¤ä¸Šçš„å›°éš¾ï¼Œä¸ç†Ÿæ‚‰ä»£ç çš„äººåœ¨ä¸æµè§ˆæ•´ä¸ª reducer ä¹‹å‰ï¼Œå¾ˆéš¾çŸ¥é“è¿™ä¸ª reducer åˆ°åº•æ“ä½œäº†å“ªäº›æ•°æ®ã€‚æ›´ç†æƒ³çš„ reducer å¯èƒ½é•¿è¿™æ ·ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">pokemonListReducer&lt;/span>(value: &lt;span style="color:#66d9ef">inout&lt;/span> PokemonList, action: AppAction) -&amp;gt; Void {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">switch&lt;/span> action {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">case&lt;/span> .loadPokemon(&lt;span style="color:#66d9ef">let&lt;/span> result):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> value.pokemons = result &lt;span style="color:#75715e">// ğŸ‘ˆ åªèƒ½æ“ä½œ pokemonList&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">default&lt;/span>:
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">break&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åªæ˜¯è¿™æ ·æ”¹åŠ¨ä¹‹åï¼Œä¹‹å‰å®šä¹‰çš„ combine å°±æ— æ³•ç¼–è¯‘é€šè¿‡ï¼ŒpokemonListReducer çš„ç­¾åå·²ç»ä¸ç¬¦åˆ combine çš„è¦æ±‚äº†ã€‚&lt;/p>
&lt;blockquote>
&lt;p>Cannot convert value of type â€˜(inout PokemonList, AppAction) -&amp;gt; ()â€™ to expected argument&lt;/p>
&lt;/blockquote>
&lt;h3 id="æ‹‰å›">
æ‹‰å›
&lt;a href="#%e6%8b%89%e5%9b%9e" class="h-anchor" aria-hidden="true">#&lt;/a>
&lt;/h3>
&lt;p>è§£å†³è¿™ä¸ªé—®é¢˜å¯ä»¥å¼•å…¥ä¸€ä¸ªæ•°å­¦ä¸­çš„æ¦‚å¿µ â€”â€” æ‹‰å›ã€‚&lt;/p>
&lt;blockquote>
&lt;p>å¼•ç”¨ wikipedia ä¸Šçš„è§£é‡Šï¼šâ€œç®€å•åœ°è¯´ï¼Œè®¾ &lt;em>f&lt;/em> æ˜¯ä¸€ä¸ªå˜é‡ &lt;em>y&lt;/em> çš„å‡½æ•°ï¼Œè¿™é‡Œ &lt;em>y&lt;/em> è‡ªèº«åˆæ˜¯å¦ä¸€ä¸ªå˜é‡ &lt;em>x&lt;/em> çš„å‡½æ•°ï¼Œé‚£ä¹ˆ &lt;em>f&lt;/em> å¯ä»¥å†™æˆ &lt;em>x&lt;/em> çš„å‡½æ•°ï¼Œè¿™å³ &lt;em>f&lt;/em> è¢«å‡½æ•° &lt;em>y&lt;/em>(&lt;em>x&lt;/em>) æ‹‰å›ã€‚â€&lt;/p>
&lt;/blockquote>
&lt;p>åœ¨ reducer ä¸­çš„ä¾‹å­é‡Œï¼Œä¹Ÿå¯ä»¥å¥—ç”¨ç›¸åŒçš„æ¦‚å¿µã€‚åªéœ€è¦å°†æŒæœ‰äº†éƒ¨åˆ†çŠ¶æ€æ•°æ®çš„ reducerï¼Œè½¬åŒ–æˆä¸€ä¸ªæ‹¥æœ‰ç€å…¨éƒ¨çŠ¶æ€æ•°æ®çš„ reducer ç­¾åå³å¯ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">pullback&lt;/span>&amp;lt;LocalValue, GlobalValue, Action&amp;gt;(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">_&lt;/span> reducer: @escaping (&lt;span style="color:#66d9ef">inout&lt;/span> LocalValue, Action) -&amp;gt; Void,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">get&lt;/span>: @escaping (GlobalValue) -&amp;gt; LocalValue,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">set&lt;/span>: @escaping (&lt;span style="color:#66d9ef">inout&lt;/span> GlobalValue, LocalValue) -&amp;gt; Void
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>) -&amp;gt; (&lt;span style="color:#66d9ef">inout&lt;/span> GlobalValue, Action) -&amp;gt; Void {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> { globalValue, action &lt;span style="color:#66d9ef">in&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">var&lt;/span> localValue = &lt;span style="color:#66d9ef">get&lt;/span>(globalValue)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> reducer(&amp;amp;localValue, action)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">set&lt;/span>(&amp;amp;globalValue, localValue)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¯¥å‡½æ•°åŒ…å«ä¸‰ä¸ªå…¥å‚ï¼š&lt;/p>
&lt;ol>
&lt;li>ç”¨äºå¤„ç†å±€éƒ¨çŠ¶æ€çš„ reducer&lt;/li>
&lt;li>æä¾›ä»å…¨éƒ¨çŠ¶æ€ä¸­æå–éƒ¨åˆ†çŠ¶æ€çš„å‡½æ•°&lt;/li>
&lt;li>æä¾›å°†å±€éƒ¨çŠ¶æ€è®¾ç½®åˆ°å…¨éƒ¨çŠ¶æ€ä¸­çš„å‡½æ•°&lt;/li>
&lt;/ol>
&lt;p>è¿™æ ·å°±å¾—åˆ°äº†ä¸€ä¸ªå¯ä»¥ç”¨æ¥è½¬åŒ–ç”¨äºå¤„ç†å±€éƒ¨çŠ¶æ€ reducer åˆ°å…¨éƒ¨çŠ¶æ€ reducer çš„ pullback å‡½æ•°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>pullback(pokemonListReducer,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">get&lt;/span>: { $0.pokemonList },
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">set&lt;/span>: { $0.pokemonList = $1 }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> )
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å†è¿›ä¸€æ­¥è¿˜å¯ä»¥é€šè¿‡ keyPath æ¥ä¼˜åŒ– pullback å‡½æ•°ï¼š&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">func&lt;/span> &lt;span style="color:#a6e22e">pullback&lt;/span>&amp;lt;LocalValue, GlobalValue, Action&amp;gt;(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">_&lt;/span> reducer: @escaping (&lt;span style="color:#66d9ef">inout&lt;/span> LocalValue, Action) -&amp;gt; Void,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> value: WritableKeyPath&amp;lt;GlobalValue, LocalValue&amp;gt;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>) -&amp;gt; (&lt;span style="color:#66d9ef">inout&lt;/span> GlobalValue, Action) -&amp;gt; Void {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#66d9ef">return&lt;/span> { globalValue, action &lt;span style="color:#66d9ef">in&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> reducer(&amp;amp;globalValue[keyPath: value], action)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>}
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>pullback(pokemonListReducer, value: &lt;span style="color:#960050;background-color:#1e0010">\&lt;/span>AppState.pokemonList)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™æ ·å°±å®ç°äº† reducer çš„æ‹†åˆ†ä»¥åŠå¯¹å¤„ç†çŠ¶æ€çš„éš”ç¦»&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-swift" data-lang="swift">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#66d9ef">let&lt;/span> appReducer = combine(
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pullback(accountReducer, value: &lt;span style="color:#960050;background-color:#1e0010">\&lt;/span>.pokemonList),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pullback(pokemonListReducer, value: &lt;span style="color:#960050;background-color:#1e0010">\&lt;/span>.settings),
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> pullback(favoritePokemonReducer, value: &lt;span style="color:#960050;background-color:#1e0010">\&lt;/span>.favoritePokemons)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>)
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="å‚è€ƒèµ„æ–™">
å‚è€ƒèµ„æ–™
&lt;a href="#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99" class="h-anchor" aria-hidden="true">#&lt;/a>
&lt;/h2>
&lt;ul>
&lt;li>&lt;a href="https://objccn.io/products/swift-ui">ObjC ä¸­å›½ - SwiftUI ä¸ Combine ç¼–ç¨‹&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.pointfree.co/collections/composable-architecture/reducers-and-stores/ep69-composable-state-management-state-pullbacks#downloads">Point Free - StateÂ Pullbacks&lt;/a>&lt;/li>
&lt;li>&lt;a href="https://www.swiftbysundell.com/articles/the-power-of-key-paths-in-swift/">Swift by Sundell - The power of key paths in Swift&lt;/a>&lt;/li>
&lt;/ul></description></item></channel></rss>